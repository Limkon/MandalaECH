name: Windows Manual Build
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: false
        cache: true # 啟用 MSYS2 系統包緩存
        install: git
        path-type: minimal
        release: true

    - name: Disable Signature Check and Install Dependencies
      shell: msys2 {0}
      run: |
        echo "Applying NUCLEAR FIX: Disabling signature checks..."
        sed -i 's/^SigLevel.*/SigLevel = Never/' /etc/pacman.conf

        echo "Installing build tools"
        pacman -Sy --noconfirm \
          mingw-w64-x86_64-gcc \
          mingw-w64-x86_64-make

    # [優化] 獲取 OpenSSL 最新 Commit SHA 作為緩存 Key 的一部分
    - name: Get OpenSSL Head Commit
      id: openssl-head
      shell: bash
      run: |
        sha=$(git ls-remote https://github.com/defo-project/openssl.git HEAD | awk '{ print $1 }')
        echo "sha=$sha" >> $GITHUB_OUTPUT

    # [優化] 配置 OpenSSL 靜態庫緩存
    - name: Cache OpenSSL
      id: cache-openssl
      uses: actions/cache@v4
      with:
        path: openssl_dist
        key: openssl-ech-${{ runner.os }}-${{ steps.openssl-head.outputs.sha }}

    - name: Build OpenSSL with ECH (Static from DEfO)
      if: steps.cache-openssl.outputs.cache-hit != 'true'
      shell: msys2 {0}
      run: |
        echo "Cloning OpenSSL ECH fork (DEfO project)..."
        git clone --depth 1 https://github.com/defo-project/openssl.git openssl-ech
        cd openssl-ech

        echo "Configuring OpenSSL with ECH support..."
        # 使用工作目錄絕對路徑作為安裝前綴，確保緩存與鏈接路徑一致
        ./Configure mingw64 no-shared enable-ech --prefix=${GITHUB_WORKSPACE}/openssl_dist

        echo "Compiling OpenSSL..."
        mingw32-make -j8
        mingw32-make install_sw
        cd ..
        rm -rf openssl-ech

    - name: Compile Resources
      shell: msys2 {0}
      run: |
        # 預先編譯資源文件，確保圖標與版本資訊嵌入
        windres -i resource.rc -o resource.res --target=pe-x86-64 -O coff

    - name: Compile Executable
      shell: msys2 {0}
      run: |
        # 優化點：
        # 1. 使用 -I 準確指向緩存的標頭路徑
        # 2. 同時添加 lib 和 lib64 路徑以兼容 OpenSSL 的安裝佈局
        # 3. 靜態鏈接所有依賴庫，確保發布後無 DLL 缺失問題
        gcc gui.c config.c proxy.c crypto.c utils.c globals.c cJSON.c resource.res -o Mandala.exe \
          -I${GITHUB_WORKSPACE}/openssl_dist/include \
          -L${GITHUB_WORKSPACE}/openssl_dist/lib \
          -L${GITHUB_WORKSPACE}/openssl_dist/lib64 \
          -lssl -lcrypto -lws2_32 -lgdi32 -lcomctl32 -lwininet -lcrypt32 -luser32 \
          -mwindows -municode -finput-charset=UTF-8 \
          -static

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Mandala-Windows-x64-ECH
        path: Mandala.exe
