name: Windows Manual Build
# 手动触发
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest  # windows-2025 也行，但 latest 通常更稳定
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: false          # 关闭自动更新，避免签名问题
        cache: false
        install: git           # 只预装 git，其他后面自己装
        path-type: minimal
        release: true

    - name: Disable Signature Check and Install Dependencies
      shell: msys2 {0}
      run: |
        echo "Applying NUCLEAR FIX: Disabling signature checks entirely..."
        sed -i 's/^SigLevel.*/SigLevel = Never/' /etc/pacman.conf

        echo "Installing build tools..."
        pacman -Sy --noconfirm \
          mingw-w64-x86_64-gcc \
          mingw-w64-x86_64-make \
          mingw-w64-x86_64-perl \
          mingw-w64-x86_64-winpthreads \
          mingw-w64-x86_64-libwinpthread-git

    - name: Build OpenSSL with ECH (Static from DEfO)
      shell: msys2 {0}
      run: |
        echo "Cloning OpenSSL ECH fork (DEfO project)..."
        git clone --depth 1 https://github.com/defo-project/openssl.git openssl-ech
        cd openssl-ech

        echo "Configuring OpenSSL with ECH support..."
        ./Configure mingw64 no-shared enable-ech --prefix=/mingw64

        echo "Compiling OpenSSL (this may take 10-20 minutes)..."
        # 关键修复：使用 mingw32-make 而不是 make
        # 并行编译，使用 runner 的所有核心（windows-latest 有 7 个逻辑核心，-j8 很安全）
        mingw32-make -j8

        echo "Installing OpenSSL (only libraries and headers)..."
        mingw32-make install_sw

        # 可选：清理一下，节省空间
        cd ..
        rm -rf openssl-ech

    - name: Compile Resources
      shell: msys2 {0}
      run: |
        windres -i resource.rc -o resource.res --target=pe-x86-64 -O coff

    - name: Compile Executable
      shell: msys2 {0}
      run: |
        gcc gui.c config.c proxy.c crypto.c utils.c globals.c cJSON.c resource.res -o Mandala.exe \
          -lssl -lcrypto -lws2_32 -lgdi32 -lcomctl32 -lwininet -lcrypt32 -luser32 \
          -mwindows -municode -finput-charset=UTF-8 \
          -static

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Mandala-Windows-x64
        path: Mandala.exe
