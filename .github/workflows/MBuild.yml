name: X Windows Manual Build

# 手动触发
on:
  workflow_dispatch:

jobs:
  build-chain:
    name: Build Mandala Executable
    runs-on: windows-latest
    
    steps:
      # ----------------------------------------------------------------
      # 第一阶段：环境准备与依赖安装 (Dependency Phase)
      # ----------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2 & Enable Cache
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          # 1. 开启缓存：自动缓存 Pacman 下载包，加速后续构建
          cache: true
          # 2. 关闭自动更新：防止启动崩溃
          update: false
          install: git

      - name: Configure Pacman & Install Dependencies
        shell: msys2 {0}
        run: |
          echo "--- [Phase 1] Configuring Environment ---"
          echo "Applying NUCLEAR FIX: Disabling signature checks entirely..."
          
          # 3. 暴力修改配置，信任所有包
          sed -i 's/^SigLevel.*/SigLevel = Never/' /etc/pacman.conf
          
          echo "Syncing database and installing toolchain..."
          # 这里的下载内容将被 setup-msys2 自动缓存
          pacman -Sy --noconfirm mingw-w64-x86_64-gcc mingw-w64-x86_64-openssl mingw-w64-x86_64-make

      # ----------------------------------------------------------------
      # 第二阶段：构建可执行文件 (Build Phase)
      # ----------------------------------------------------------------
      - name: Compile Resources
        shell: msys2 {0}
        run: |
          echo "--- [Phase 2] Building Resources ---"
          windres -i resource.rc -o resource.res --target=pe-x86-64 -O coff

      - name: Compile Executable
        shell: msys2 {0}
        run: |
          echo "--- [Phase 2] Compiling Binary ---"
          # 编译指令保持不变，包含 globals.c
          gcc gui.c config.c proxy.c crypto.c utils.c globals.c cJSON.c resource.res -o Mandala.exe \
            -lssl -lcrypto -lws2_32 -lgdi32 -lcomctl32 -lwininet -lcrypt32 -luser32 \
            -mwindows -municode -finput-charset=UTF-8 -static

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Mandala-executable
          path: Mandala.exe
